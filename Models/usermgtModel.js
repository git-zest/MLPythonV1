var mongoose=require('mongoose');
var Schema=mongoose.Schema;
mongoose.Promise = require('bluebird');
var db=mongoose.connection;
var bcrypt=require('bcryptjs');


var usermgt=new Schema({
		username:String,
		password: String,
		channel: String,
		environment: String,
		indicator:String,
		portfolio:String,
		comments:String,
});

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////d///////////////////////////////////////////////////////////////////////////////////////////////////////////////
var usermgtObj=mongoose.model('usermgt',usermgt);
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
module.exports.generateharsh=function(Password1,callback){
	var salt = bcrypt.genSaltSync(10);
	var hash = bcrypt.hashSync(Password1, salt);
	//console.log(hash);
	callback(hash);
}
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

module.exports.searchusermgtdata=function(environment,callback){
	var quryfind={'environment':environment};
	////console.log('Both NULL');
	////console.log(quryfind);
	mongoose.connect("mongodb://userHKT:lrADL3lNvj2ug0gT@172.31.55.187:27017/transaction", function(err) {
	if(err){
		////console.log('DB error occured');
		models="DB Fail";
		db.close();
		mongoose.connection.close();
		callback(models);
	}
	usermgtObj.find(quryfind,function(err,docs){
		////console.log("retrieved records:");
			////console.log(docs);
			db.close();
			mongoose.connection.close();
			callback(docs);
	});
});
}

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
var CryptoJS = require("crypto-js");
module.exports.createusermgt=function(username,password,channel,environment,indicator,portfolio,comments,callback) {
	mongoose.connect("mongodb://userHKT:lrADL3lNvj2ug0gT@172.31.55.187:27017/transaction", function(err) {
	if(err){
		////console.log('DB error occured');
		modelslogin="DB Fail";
		callback(modelslogin);
	}
	usermgtfeeder.generateharsh(password,function(hash){
	var ciphertext = CryptoJS.AES.encrypt(password, 'secret key 123').toString();
	var usermgtObjnew=new usermgtObj({"username":username,"password":ciphertext,"channel":channel,"environment":environment,"indicator":indicator,"portfolio":portfolio,"comments":	""});
	usermgtObjnew.save(function(err){
	if(err){
							models='Fail';
							mongoose.connection.close();
							callback(models)
	}else{
							mongoose.connection.close();
							callback('testdata created');
	}
	});
});
	////console.log({"url":url,"username":username,"password":password,"customernumber":customernumber,"product":product,"pricingoption":	pricingoption
});
}


////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
module.exports.deletetestcase=function(id,callback) {
	////console.log("test");
	////console.log(id);
	mongoose.connect("mongodb://userHKT:lrADL3lNvj2ug0gT@172.31.55.187:27017/transaction", function(err) {
	if(err){
		////console.log('DB error occured');
		modelslogin="DB Fail";
		callback(modelslogin);
	}
	////console.log("deleting the message");
	var usermgtObjnew=new usermgtObj({"_id":id});
	usermgtObjnew.remove(function(err){
	if(err){
							////console.log('error');
							models='Fail';
						  mongoose.connection.close();
			    		callback(models);
	}else{
							mongoose.connection.close();
							callback('deleted');
	}
	});
});
}
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
module.exports.srchusermgtdata=function(str_portfolio,str_environment,callback){
	var quryfind={"environment":str_environment,"portfolio":str_portfolio,"indicator":'N',"channel":'MCA'};
	////console.log('Both NULL');
	////console.log(quryfind);
	mongoose.connect("mongodb://userHKT:lrADL3lNvj2ug0gT@172.31.55.187:27017/transaction", function(err) {
	if(err){
		////console.log('DB error occured');
		models="DB Fail";
		db.close();
		mongoose.connection.close();
		callback(models);
	}
	usermgtObj.find(quryfind,function(err,docs){
		////console.log("retrieved records:");
			////console.log(docs);
			db.close();
			mongoose.connection.close();
			callback(docs);
	});
});
}
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
module.exports.srchbpmusermgtdata=function(str_bpmusername,str_environment,callback){
	var quryfind={"environment":str_environment,"username":str_bpmusername};
	////console.log('Both NULL');
	////console.log(quryfind);
	mongoose.connect("mongodb://userHKT:lrADL3lNvj2ug0gT@172.31.55.187:27017/transaction", function(err) {
	if(err){
		////console.log('DB error occured');
		models="DB Fail";
		db.close();
		mongoose.connection.close();
		callback(models);
	}
	usermgtObj.find(quryfind,function(err,docs){
		////console.log("retrieved records:");
			////console.log(docs);
			db.close();
			mongoose.connection.close();
			callback(docs);
	});
});
}
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
module.exports.updtusermgtdata=function(str_username,str_environment,callback){
	var quryfind={"username":str_username,"environment":str_environment};
	////console.log('Both NULL');
	////console.log(quryfind);
	mongoose.connect("mongodb://userHKT:lrADL3lNvj2ug0gT@172.31.55.187:27017/transaction", function(err) {
	if(err){
		////console.log('DB error occured');
		models="Fail";
		db.close();
		mongoose.connection.close();
		callback(models);
	}
	usermgtObj.findOne(quryfind,function(err,usermgt){
				usermgt.indicator="Y";
				usermgt.save(function(err){
					if(err){
							models='Fail';
							mongoose.connection.close();
							callback(models);

					}else{
							models='Pass';
							mongoose.connection.close();
							callback(models);

					}

				});
			});
});
}
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
module.exports.rmindicatorusermgtdata=function(str_username,str_environment,callback){
	var quryfind={username:str_username,"environment":str_environment};
	////console.log('Both NULL');
	////console.log(quryfind);
	mongoose.connect("mongodb://userHKT:lrADL3lNvj2ug0gT@172.31.55.187:27017/transaction", function(err) {
	if(err){
		////console.log('DB error occured');
		models="Fail";
		db.close();
		mongoose.connection.close();
		callback(models);
	}
	usermgtObj.findOne(quryfind,function(err,usermgt){
				usermgt.indicator="N";
				usermgt.save(function(err){
					if(err){
							models='Fail';
							mongoose.connection.close();
							callback(models);

					}else{
							models='Pass';
							mongoose.connection.close();
							callback(models);

					}

				});
			});
});
}
